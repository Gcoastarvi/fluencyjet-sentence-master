// ------------------------------------------------------
// FluencyJet Prisma Schema (Launch-Safe PLG Extension)
// ------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------
// üë§ USER MODEL (UNCHANGED)
// ------------------------------------------------------
model User {
  id         Int      @id @default(autoincrement())
  name       String?  @db.VarChar(100)
  email      String   @unique @db.VarChar(191)
  username   String?  @unique @db.VarChar(50)
  password   String
  avatar_url String?
  has_access Boolean  @default(false)
  tier_level String   @default("free")
  plan       String   @default("FREE")
  created_at DateTime @default(now())
  isAdmin    Boolean  @default(false)

  lastActiveAt DateTime?
  xpTotal      Int       @default(0)

  progress    UserProgress?
  weekly      UserWeeklyTotals?
  xp_events   XpEvent[]
  user_badges UserBadge[]
  payments    Payment[]

  // üî• PLG extension
  profile UserProfile?
}

// ------------------------------------------------------
// üéØ XP EVENT LOGS
// ------------------------------------------------------
model XpEvent {
  id         Int      @id @default(autoincrement())
  user_id    Int
  xp_delta   Int
  type       String   @db.VarChar(50)
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@unique([user_id, type])
}

// ------------------------------------------------------
// üìà WEEKLY TOTALS
// ------------------------------------------------------
model UserWeeklyTotals {
  id         Int       @id @default(autoincrement())
  user_id    Int       @unique
  week_key   DateTime
  month_key  DateTime?
  week_xp    Int       @default(0)
  month_xp   Int       @default(0)
  updated_at DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id])
}

// ------------------------------------------------------
// üß† USER PROGRESS
// ------------------------------------------------------
model UserProgress {
  id         Int      @id @default(autoincrement())
  user_id    Int      @unique
  xp         Int      @default(0)
  streak     Int      @default(0)
  badges     String[] @default([])
  updated_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

// ------------------------------------------------------
// üèÖ USER BADGES
// ------------------------------------------------------
model UserBadge {
  id         Int      @id @default(autoincrement())
  user_id    Int
  badge_name String
  earned_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

// ------------------------------------------------------
// üìò LESSONS
// ------------------------------------------------------
model Lesson {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  description String?
  difficulty  String   @default("beginner")
  isLocked    Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  quizzes Quiz[]
}

// ------------------------------------------------------
// üìù QUIZ
// ------------------------------------------------------
model Quiz {
  id       Int    @id @default(autoincrement())
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId Int

  question String
  type     String  @default("typing")
  prompt   String?
  data     Json?
  xpReward Int     @default(50)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// ------------------------------------------------------
// üí≥ PAYMENTS
// ------------------------------------------------------
model Payment {
  id String @id @default(cuid())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  orderId   String  @unique
  paymentId String? @unique
  signature String?

  amount   Int
  currency String
  status   String
  plan     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ======================================================
// üöÄ PLG FUNNEL ‚Äî NEW MODELS (SAFE ADDITION)
// ======================================================

// ---------- Diagnostic Quiz ----------
model DiagnosticQuestion {
  id         String      @id @default(uuid())
  isActive   Boolean     @default(true)
  type       QuizType
  promptEn   String?
  promptTa   String?
  payload    Json
  tag        WeaknessTag
  difficulty Int         @default(1)
  createdAt  DateTime    @default(now())
}

model DiagnosticAttempt {
  id           String    @id @default(uuid())
  anonId       String
  userId       Int?
  score        Int
  level        UserLevel
  weaknessTags String[]
  answers      Json
  createdAt    DateTime  @default(now())
}

// ---------- User Profile ----------
model UserProfile {
  userId        Int           @id
  level         UserLevel
  weaknessTags  String[]
  webinarStatus WebinarStatus @default(NOT_SHOWN)
  planStatus    PlanStatus    @default(FREE)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])
}

// ---------- Practice Path ----------
model PracticeDay {
  id        String    @id @default(uuid())
  level     UserLevel
  dayNumber Int
  titleEn   String
  titleTa   String
  isActive  Boolean   @default(true)

  exercises PracticeExercise[]

  @@unique([level, dayNumber])
  @@index([level, isActive])
}

model PracticeExercise {
  id            String       @id @default(uuid())
  practiceDayId String
  type          ExerciseType
  promptTa      String
  hintTa        String?
  structureEn   String?
  expected      Json
  xp            Int          @default(50)
  orderIndex    Int

  practiceDay PracticeDay @relation(fields: [practiceDayId], references: [id])

  @@unique([practiceDayId, type, orderIndex])
  @@index([practiceDayId, type, orderIndex])
}

model UserDayProgress {
  id          String    @id @default(uuid())
  userId      Int
  level       UserLevel
  dayNumber   Int
  completed   Boolean   @default(false)
  xpEarned    Int       @default(0)
  completedAt DateTime?

  @@unique([userId, level, dayNumber])
  @@index([userId, level])
}

// ---------- Automation ----------
model AutomationEvent {
  id        String           @id @default(uuid())
  userId    Int
  eventType AutomationType
  status    AutomationStatus @default(PENDING)
  payload   Json?
  createdAt DateTime         @default(now())
  sentAt    DateTime?
}

// ------------------------------------------------------
// üîê ENUMS
// ------------------------------------------------------
enum QuizType {
  FILL_BLANK
  ORDERING
  TA_TRANSLATION
  ERROR_SPOTTING
}

enum WeaknessTag {
  grammar
  word_order
  translation
  sentence_flow
  confidence
}

enum UserLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum WebinarStatus {
  NOT_SHOWN
  SHOWN
  REGISTERED
  ATTENDED
}

enum PlanStatus {
  FREE
  PAID
}

enum ExerciseType {
  MAKE_SENTENCE
  FILL_BLANK
  DRAG_DROP
  TRANSLATE
}

enum AutomationType {
  DAY3_WEBINAR
  DAY5_UPGRADE
}

enum AutomationStatus {
  PENDING
  SENT
  DONE
}
