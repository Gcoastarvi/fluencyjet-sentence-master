// index.js â€“ FluencyJet backend API

import "dotenv/config";
import express from "express";
import cors from "cors";
import compression from "compression";
import cookieParser from "cookie-parser";
import morgan from "morgan";

import authRouter from "./routes/auth.js";

const app = express();

// â”€â”€ Basic middleware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(compression());
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(cookieParser());

// CORS: allow your frontend origin(s)
const allowedOrigins = (process.env.FRONTEND_ORIGINS || "")
  .split(",")
  .map(o => o.trim())
  .filter(Boolean);

app.use(
  cors({
    origin: allowedOrigins.length > 0 ? allowedOrigins : true,
    credentials: true,
  })
);

// Request logging (good for debugging on Railway)
app.use(morgan("dev"));

// â”€â”€ Health check for Railway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get("/api/health", (req, res) => {
  res.json({ ok: true, message: "API is healthy" });
});

// â”€â”€ Auth routes (/api/auth/...) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use("/api/auth", authRouter);

// â”€â”€ 404 handler for unknown API routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use("/api", (req, res) => {
  res.status(404).json({ ok: false, message: "API route not found" });
});

// â”€â”€ Global error handler (last resort) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use((err, req, res, next) => {
  console.error("UNHANDLED ERROR:", err);
  res
    .status(500)
    .json({ ok: false, message: "Internal server error.", error: err.message });
});

// â”€â”€ Start server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PORT = process.env.PORT || 8080;
app.listen(PORT, () => {
  console.log(`ðŸš€ FluencyJet API running on port ${PORT}`);
  console.log("   Allowed origins:", allowedOrigins.length ? allowedOrigins : "ALL");
});
