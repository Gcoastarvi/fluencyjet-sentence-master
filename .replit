modules = ["nodejs-22", "web"]

# Run the production server that serves /client/dist
run = """
bash -lc '
  set -e
  export PORT=${PORT:-8080}
  echo "â–¶ Using Replit-assigned port: $PORT"

  echo "ğŸ“¦ Installing client deps (if missing)â€¦"
  [ -d client/node_modules ] || npm --prefix client install --no-audit --no-fund

  echo "ğŸ—ï¸ Building clientâ€¦"
  npm --prefix client run build

  echo "ğŸš€ Starting server (production mode)â€¦"
  NODE_ENV=production PORT=$PORT node server/index.js
'
"""

hidden = [
  ".config",
  ".git",
  "generated-icon.png",
  "node_modules",
  "client/node_modules",
  "dist",
  "client/dist",
]

[nix]
channel = "stable-24_05"

[env]
HOST = "0.0.0.0"

[deployment]
deploymentTarget = "run"

[[ports]]
localPort = 3000
externalPort = 80

[[ports]]
localPort = 8080
externalPort = 8080

[[ports]]
localPort = 44895
externalPort = 3000

# You can omit the [[ports]] section entirely â€” Replit auto-detects the open port.
