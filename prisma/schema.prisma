generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int               @id @default(autoincrement())
  email       String            @unique @db.VarChar(254)
  password    String
  username    String?           @unique @db.VarChar(32)
  avatar_url  String?
  has_access  Boolean           @default(false)
  tier_level  TierLevel         @default(free)
  created_at  DateTime          @default(now())
  name        String?           @db.VarChar(100)
  user_badges UserBadge[]
  progress    UserProgress?
  weekly      UserWeeklyTotals?
  xp_events   XpEvent[]

  @@index([created_at])
}

model Lesson {
  id         Int        @id @default(autoincrement())
  slug       String     @unique
  title      String
  difficulty Difficulty @default(beginner)
  is_locked  Boolean    @default(true)
  created_at DateTime   @default(now())

  @@index([difficulty])
  @@index([is_locked])
}

model XpEvent {
  id         BigInt    @id @default(autoincrement())
  user_id    Int
  event_type EventType
  xp_delta   Int
  meta       Json?
  created_at DateTime  @default(now())
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([created_at])
}

model Badge {
  id          Int         @id @default(autoincrement())
  code        String      @unique
  name        String
  threshold   Int
  user_badges UserBadge[]

  @@index([threshold])
}

model UserBadge {
  id         BigInt   @id @default(autoincrement())
  user_id    Int
  badge_id   Int
  awarded_at DateTime @default(now())
  badge      Badge    @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
  @@index([awarded_at])
}

/// One row per user; fast reads for weekly/monthly leaderboards.
model UserWeeklyTotals {
  user_id    Int      @id
  week_key   DateTime
  week_xp    Int      @default(0)
  month_key  DateTime
  month_xp   Int      @default(0)
  updated_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([week_xp])
  @@index([month_xp])
}

/// Progress snapshot + rolling “bucket” keys.
/// Legacy fields kept for compatibility; extended for streaks & lessons.
model UserProgress {
  user_id        Int       @id
  total_xp       Int       @default(0)
  last_activity  DateTime?
  week_key       DateTime  @default(dbgenerated("date_trunc('week'::text, (now() AT TIME ZONE 'utc'::text))")) @db.Timestamptz(6)
  month_key      DateTime  @default(dbgenerated("date_trunc('month'::text, (now() AT TIME ZONE 'utc'::text))")) @db.Timestamptz(6)
  week_xp        Int       @default(0)
  month_xp       Int       @default(0)
  lifetime_xp    Int       @default(0)
  badges_awarded Int       @default(0)
  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([total_xp])
  @@index([week_key])
  @@index([month_key])
}

model TypingQuiz {
  id        Int      @id @default(autoincrement())
  ta        String
  en        String
  lesson    String
  createdAt DateTime @default(now()) @db.Timestamp(6)
}

enum Difficulty {
  beginner
  intermediate
  advanced
}

enum TierLevel {
  free
  basic
  pro
}

enum EventType {
  quiz
  streak
  bonus
  admin
  QUESTION_CORRECT
  QUIZ_COMPLETED
  LESSON_COMPLETED
  DAILY_STREAK
  BADGE_UNLOCK
  ADMIN_ADJUST
  GENERIC
}
model QuizQuestion {
  id          Int       @id @default(autoincrement())
  ta          String
  en          String
  difficulty  Difficulty @default(beginner)
  lesson_id   Int?
  audio_url   String?   @db.VarChar(512)
  created_at  DateTime  @default(now())
}
