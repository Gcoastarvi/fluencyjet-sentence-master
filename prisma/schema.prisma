// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ========================= Models ========================= */

model User {
  id          Int               @id @default(autoincrement())
  email       String            @unique @db.VarChar(254)
  password    String
  username    String?           @unique @db.VarChar(32)
  avatar_url  String?
  has_access  Boolean           @default(false)
  tier_level  TierLevel         @default(free)
  created_at  DateTime          @default(now())

  user_badges UserBadge[]
  progress    UserProgress?
  weekly      UserWeeklyTotals?
  xp_events   XpEvent[]

  @@index([created_at])
}

model Lesson {
  id         Int        @id @default(autoincrement())
  slug       String     @unique
  title      String
  difficulty Difficulty @default(beginner)
  is_locked  Boolean    @default(true)
  created_at DateTime   @default(now())

  @@index([difficulty])
  @@index([is_locked])
}

model XpEvent {
  id         BigInt    @id @default(autoincrement())
  user_id    Int
  event_type EventType
  xp_delta   Int
  meta       Json?
  created_at DateTime  @default(now())

  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([created_at])
}

model Badge {
  id          Int         @id @default(autoincrement())
  code        String      @unique        // e.g., B_STARTER, B_7_DAY_STREAK
  name        String
  threshold   Int                          // e.g., XP needed or streak length
  user_badges UserBadge[]

  @@index([threshold])
}

model UserBadge {
  id         BigInt   @id @default(autoincrement())
  user_id    Int
  badge_id   Int
  awarded_at DateTime @default(now())

  badge      Badge    @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
  @@index([awarded_at])
}

/**
 * We keep ONE row per user and roll week/month keys via a cron.
 * Fast reads for weekly/monthly leaderboards.
 */
model UserWeeklyTotals {
  user_id    Int      @id
  week_key   DateTime
  week_xp    Int      @default(0)
  month_key  DateTime
  month_xp   Int      @default(0)
  updated_at DateTime @default(now())

  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([week_xp])
  @@index([month_xp])
}

/**
 * Fast lifetime stats so we don’t SUM(xp_events) each time.
 * xp_events is still the source of truth.
 */
model UserProgress {
  user_id       Int       @id
  total_xp      Int       @default(0)
  last_activity DateTime?
  user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([total_xp])
}

/* ========================= Enums ========================= */

enum Difficulty {
  beginner
  intermediate
  advanced
}

enum TierLevel {
  free
  basic
  pro
}

/**
 * Aligns with the Phase-4 plan and your routes.
 * Add GENERIC so unknown/legacy values don’t crash writes.
 */
enum EventType {
  quiz
  streak
  bonus
  admin
  QUESTION_CORRECT   // per-question XP
  QUIZ_COMPLETED     // +300 completion bonus
  LESSON_COMPLETED   // if you log per-lesson milestones
  DAILY_STREAK       // +200 first activity of day
  BADGE_UNLOCK       // informational XP log when a badge is granted
  ADMIN_ADJUST       // manual admin credit/debit
  GENERIC            // safe fallback
}
